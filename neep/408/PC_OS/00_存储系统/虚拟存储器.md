[toc]

## 传统存储管理特点

- 传统的内存内存管理策略,是为了同时将多个进程保留在内存中,以便允许进行多道程序设计
- 这些策略具有两个共同特征
  - 一次性
    - 作业必须一次性全部装入内存才能开始运行
      - 当作业很大无法全部装入内存,作业就无法运行
      - 当大量作业要求运行时,由于内存不足以容纳所有作业,只能够使得少数作业先运行,降低了多道程序度
  - 驻留性
    - 作业被装入内存年后,就一直驻留在内存中,任何部分都不会被换出,直至作业运行结束
    - 运行中的进程可能会因为等待IO而被阻塞,可能长期处于等待状态,浪费了宝贵的内存资源

## 高速缓存技术

- 快表/页高速缓存/虚拟内存 都属于高速缓存技术
- 这类技术主要依赖于**局部性原理**

## 虚拟存储器

- VirtualMemory(VM/VS)
  - In [computing](https://en.wikipedia.org/wiki/Computing), **virtual memory**, or **virtual storage**[[b\]](https://en.wikipedia.org/wiki/Virtual_memory#cite_note-4) is a [memory management](https://en.wikipedia.org/wiki/Memory_management_(operating_systems)) technique that provides an "idealized abstraction of the storage resources that are actually available on a given machine"[[3\]](https://en.wikipedia.org/wiki/Virtual_memory#cite_note-5) which "creates the illusion to users of a very large (main) memory"

- 基于局部性原理，在程序装入时，<u>仅须将程序当前要运行的少数页面或段</u>先装入内存，而将其余部分暂留在外存，便可启动程序执行。
  - 在程序执行过程中，当所访问的信息**不在内存时**，由操作系统**将所需要的部分调入内存**，然后继续执行程序。
  - 另一方面，操作系统将内存中**暂时不使用的内容换出到外存**上，从而**腾出空间存放将要调入内存的信息**。
  - 这样，系统好像为用户提供了一个<u>比实际内存容量大得多的存储器</u>，称为虚拟存储器。
- 之所以将其称为虚拟存储器，是因为这种存储器实际上并不存在
  - 只是由于系统提供了部分装入、请求调入和置换功能后（对用户透明)，给用户的感觉是好像存在一个比实际物理内存大得多的存储器。
  - 但容量大只是一种错觉，是虚的。

### 特点1

- 虚拟存储器有以下三个主要特征:
  - 1)多次性。
    - 是指无须在作业运行时一次性地全部装入内存，而允许被分成多次调入内存运行，即只需将当前要运行的那部分程序和数据装入内存即可开始运行。
    - 以后每当要运行到尚未调入的那部分程序时，再将它调入。
    - 多次性是虚拟存储器**最重要的特征**。
  - 2）对换性。
    - 是指无须在作业运行时一直常驻内存，在进程运行期间，允许将那些暂不使用的程序和数据从内存调至外存的对换区（换出)，待以后需要时再将它们从外存调至内存(换进)。
    - 正是由于对换性，才使得虚拟存储器得以正常运行。
  - 3）虚拟性。
    - 是指从**逻辑上扩充内存的容量**，使用户所看到的内存容量远大于实际的内存容量。
    - 这是虚拟存储器所**表现出的最重要特征**，也是实现虚拟存储器的**最重要目标**。

### 特点2

- 由主存和辅存共同构成虚拟存储器
- 而这在硬件和系统软件的共同管理下工作
- 对于应用级程序员而言,虚拟存储器是透明的
- 虚拟存储器具有主存的速度和辅存的容量

###  虚拟内存技术的实现

- 虚拟内存技术允许将一个作业分多次调入内存。

  - 虚拟内存的实现需要建立在**离散分配的内存管理方式**的基础上。

    - 如果采用连续分配方式时，会使相当一部分内存空间都处于暂时或“永久”的空闲状态，造成内存资源的严重浪费，而且也无法从逻辑上扩大内存容量。

    

- 虚拟内存的实现有以下三种方式:

  - 请求**分页**存储管理
  - 请求**分段**存储管理。
  - 请求<u>段页</u>式存储管理。

- 不管哪种方式，都需要有一定的硬件支持。一般需要的支持有以下几个方面:

  - 一定容量的内存和外存。
  - 页表机制(或段表机制)，作为主要的数据结构。
  - 中断机构:当用户程序要访问的部分尚未调入内存时，则产生中断。
  - 地址变换机构:逻辑地址到物理地址的变换。

### 地址空间

- 虚拟存储器将主存或辅存的**地址空间统一编址**，形成一个庞大的地址空间
  - 在这个空间内，用户可以自由编程，而不必在乎
    - 实际的主存容量
    - 程序在主存中**实际的存放位置**

#### 逻辑地址

- 用户<u>编程允许涉及的地址</u>称为**虚地址或逻辑地址**
- **虚地址**对应的存储空间称为**虚拟空间或程序空间**。
- 在组成原理中习惯用<u>虚地址(虚拟地址)</u>
- 在操作系统中惯用<u>逻辑地址</u>

#### 物理地址

- 实际的主存单元地址称为**实地址或物理地址**，实地址对应的是**主存地址空间**，也称**实地址空间**。
- 虚地址比实地址要大很多。

#### 使用虚拟地址

- CPU使用虚地址时，由辅助硬件找出<u>虚地址和实地址之间的对应关系</u>，并判断这个虚地址对应的存储单元内容**是否已装入主存**。
- 若已在主存中
  - 则通过**地址变换**，CPU可直接访问主存指示的实际单元;
- 若不在主存中
  - 则把包含这个字的一页或一段调入主存后再由CPU访问。
  - 若主存已满，则采用**替换算法**置换主存中的交换块（即页面)。
- 虚拟存储器也采用**和 Cache类似的技术**
  - 将辅存中经常访问的**数据副本存放到主存**中。
  - 但是缺页（或段）而**访问辅存的代价很大**，<u>提高命中率是关键</u>，因此虚拟存储机制采用**全相联映射**
    - 每个虚页面可以存放到对应主存区域的任何一个空闲页位置。
  - 数据一致性维护
    - 当进行写操作时，<u>不能每次写操作都同时写回磁盘</u>，因而，在处理一致性问题时，采用**回写法**。

### 页式-虚拟存储器

#### 分页

- **页式**虚拟存储器以页为基本单位。
- 虚拟空间与主存空间<u>都被划分成同样大小的页</u>
  - 主存的页称为**实页、页框**
  - 虚存的页称为**虚页**。

#### 地址结构

- 把**虚拟地址**分为两个字段:
  - 虚页号
  - 页内地址

#### 页表

- 虚拟地址到物理地址的转换是由**页表**实现的。
- 页表是一张存放在主存中的**虚页号和实页号**的**对照表**
  - 它记录程序的虚页调入主存时<u>被安排在主存中的位置</u>。
  - **页表**一般**长久地保存在内存**中。



















