[toc]

# TCPåè®®

- [Transmission Control Protocol - Wikipedia](https://en.wikipedia.org/wiki/Transmission_Control_Protocol)

- TCPæ˜¯åœ¨ä¸å¯é çš„IPå±‚ä¹‹ä¸Šå®ç°çš„å¯é çš„æ•°æ®ä¼ è¾“åè®®ï¼Œå®ƒä¸»è¦è§£å†³ä¼ è¾“çš„<u>å¯é ã€æœ‰åºã€æ— ä¸¢å¤±å’Œä¸é‡å¤é—®é¢˜</u>ã€‚

- TCPæ˜¯TCP/IPä½“ç³»ä¸­éå¸¸å¤æ‚çš„ä¸€ä¸ªåè®®ï¼Œä¸»è¦ç‰¹ç‚¹å¦‚ä¸‹ï¼š

  - 1)TCPæ˜¯é¢å‘è¿æ¥çš„ä¼ è¾“å±‚åè®®ï¼ŒTCPè¿æ¥æ˜¯ä¸€æ¡é€»è¾‘è¿æ¥ã€‚

  - 2)æ¯æ¡TCPè¿æ¥åªèƒ½æœ‰ä¸¤ä¸ªç«¯ç‚¹ï¼Œæ¯æ¡TCPè¿æ¥åªèƒ½æ˜¯ç«¯åˆ°ç«¯çš„ï¼ˆè¿›ç¨‹å¯¹è¿›ç¨‹ï¼‰ã€‚

  - 3)TCPæä¾›å¯é äº¤ä»˜çš„æœåŠ¡ï¼Œä¿è¯ä¼ é€çš„æ•°æ®

    - æ— å·®é”™
    - ä¸ä¸¢å¤±
    - ä¸é‡å¤
    - æœ‰åº

  - 4)TCPæä¾›å…¨åŒå·¥é€šä¿¡ï¼Œå…è®¸é€šä¿¡åŒæ–¹çš„åº”ç”¨è¿›ç¨‹åœ¨ä»»ä½•æ—¶å€™éƒ½èƒ½å‘é€æ•°æ®ï¼Œä¸ºæ­¤TCPè¿æ¥çš„ä¸¤ç«¯éƒ½è®¾æœ‰å‘é€ç¼“å­˜å’Œæ¥æ”¶ç¼“å­˜ï¼Œç”¨æ¥ä¸´æ—¶å­˜æ”¾åŒå‘é€šä¿¡çš„æ•°æ®ã€‚

    - å‘é€ç¼“å­˜ç”¨æ¥æš‚æ—¶å­˜æ”¾ä»¥ä¸‹æ•°æ®ï¼š
      - â‘ å‘é€åº”ç”¨ç¨‹åºä¼ é€ç»™å‘é€æ–¹TCPå‡†å¤‡å‘é€çš„æ•°æ®ï¼š
      - â‘¡TCPå·²å‘é€ä½†å°šæœªæ”¶åˆ°ç¡®è®¤çš„æ•°æ®ã€‚
    - æ¥æ”¶ç¼“å­˜ç”¨æ¥æš‚æ—¶å­˜æ”¾ä»¥ä¸‹æ•°æ®ï¼š
      - â‘ æŒ‰åºåˆ°è¾¾ä½†å°šæœªè¢«æ¥æ”¶åº”ç”¨ç¨‹åºè¯»å–çš„æ•°æ®ï¼š
      - â‘¡ä¸æŒ‰åºåˆ°è¾¾çš„æ•°æ®ã€‚

  - 5)TCPæ˜¯é¢å‘å­—èŠ‚æµçš„

    - è™½ç„¶åº”ç”¨ç¨‹åºå’ŒTCPçš„äº¤äº’æ˜¯ä¸€æ¬¡ä¸€ä¸ªæ•°æ®å—ï¼ˆå¤§å°ä¸ç­‰ï¼‰ï¼Œä½†TCPæŠŠåº”ç”¨ç¨‹åºäº¤ä¸‹æ¥çš„æ•°æ®ä»…è§†ä¸ºä¸€è¿ä¸²çš„**æ— ç»“æ„çš„å­—èŠ‚æµ**ã€‚

  - TCPå’ŒUDPåœ¨å‘é€æŠ¥æ–‡æ—¶æ‰€é‡‡ç”¨çš„æ–¹å¼å®Œå…¨ä¸åŒã€‚

    - UDPæŠ¥æ–‡çš„é•¿åº¦**ç”±å‘é€åº”ç”¨è¿›ç¨‹å†³å®š**

    - TCPæŠ¥æ–‡çš„é•¿åº¦åˆ™æ ¹æ®æ¥æ”¶æ–¹ç»™å‡ºçš„çª—å£å€¼å’Œå½“å‰ç½‘ç»œæ‹¥å¡ç¨‹åº¦æ¥å†³å®šã€‚

    - å¦‚æœåº”ç”¨è¿›ç¨‹ä¼ é€åˆ°TCPç¼“å­˜çš„æ•°æ®å—å¤ªé•¿ï¼ŒTCPå°±æŠŠå®ƒåˆ’åˆ†å¾—çŸ­ä¸€äº›å†ä¼ é€ï¼š

    - å¦‚æœå¤ªçŸ­ï¼ŒTCPä¹Ÿå¯ä»¥ç­‰åˆ°ç§¯ç´¯è¶³å¤Ÿå¤šçš„å­—èŠ‚åå†æ„æˆæŠ¥æ–‡æ®µå‘é€å‡ºå»ã€‚

      

## TCPæŠ¥æ–‡æ®µ

- TCPä¼ é€çš„**æ•°æ®å•å…ƒ**(TCP@PDU)ç§°ä¸º**æŠ¥æ–‡æ®µ**(segment)ã€‚

- TCPæŠ¥æ–‡æ®µæ—¢å¯ä»¥ç”¨æ¥**è¿è½½æ•°æ®**ï¼Œåˆå¯ä»¥ç”¨æ¥**å»ºç«‹è¿æ¥**ã€**é‡Šæ”¾è¿æ¥**å’Œ**åº”ç­”**

- ä¸€ä¸ªTCPæŠ¥æ–‡æ®µåˆ†ä¸ºé¦–éƒ¨å’Œæ•°æ®ä¸¤éƒ¨åˆ†

  - æ•´ä¸ªTCPæŠ¥æ–‡æ®µä½œä¸ºIPæ•°æ®æŠ¥çš„æ•°æ®éƒ¨åˆ†å°è£…åœ¨IPæ•°æ®æŠ¥ä¸­
  - é¦–éƒ¨åˆåˆ†ä¸ºå›ºå®šéƒ¨åˆ†å’Œé€‰é¡¹(å˜é•¿éƒ¨åˆ†)
    - å…¶é¦–éƒ¨çš„å‰20Bæ˜¯å›ºå®šçš„
    - TCPé¦–éƒ¨æœ€çŸ­ä¸º20B,åé¢æœ‰4Nå­—èŠ‚æ˜¯æ ¹æ®éœ€è¦è€Œå¢åŠ çš„é€‰é¡¹ï¼Œ**é•¿åº¦ä¸º4Bçš„æ•´æ•°å€**ã€‚
      - é¦–éƒ¨æœ€å¤§é•¿åº¦60Byte:480bit

- IPæ•°æ®æŠ¥

  - IPé¦–éƒ¨

  - æ•°æ®éƒ¨åˆ†(TCPæŠ¥æ–‡æ®µTCP segment)

    - TCPé¦–éƒ¨

      - 20(5*4B)å­—èŠ‚å›ºå®šéƒ¨åˆ†

        - |      | ç¬¬1å­—(1~4B) | ç¬¬2å­—(5~8B) | ç¬¬3å­—(9~12) | ç¬¬4å­—(13~16)                   | ç¬¬5å­—(17~20) |
          | ---- | ----------- | ----------- | ----------- | ------------------------------ | ------------ |
          | å‰2B | æºç«¯å£      | åºå·        | ç¡®è®¤å·      | æ•°æ®åç§»<br />@ä¿ç•™<br />@æ ‡å¿— | æ ¡éªŒå’Œ       |
          | å2B | ç›®çš„ç«¯å£    | åºå·        | ç¡®è®¤å·      | çª—å£                           | ç´§æ€¥æŒ‡é’ˆ     |

        - ç¬¬4å­—çš„å‰ä¸¤ä¸ªå­—èŠ‚

          - æ•°æ®åç§»ï¼ˆå³é¦–éƒ¨é•¿åº¦)
          - ä¿ç•™
          - åºå·seq(4Byte:32bit)

      - 40å­—èŠ‚å¯å˜éƒ¨åˆ†

    - æ•°æ®éƒ¨åˆ†

#### ç»“æ„ç¤ºæ„å›¾ğŸˆ

- ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/2ffca365264347bcb811c262bc3b9725.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAeHVjaGFveGluMTM3NQ==,size_16,color_FFFFFF,t_70,g_se,x_16)
- ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/62c6f185b3d34e159fe064dc285a9912.png)

###  å­—æ®µğŸˆ

#### åŸºç¡€å­—æ®µğŸˆ

- 1ï¼‰æºç«¯å£(source port)å’Œç›®çš„ç«¯å£(destination port)
  - å„å 2Bã€‚
  - ç«¯å£æ˜¯è¿è¾“å±‚ä¸åº”ç”¨å±‚çš„æœåŠ¡æ¥å£ï¼Œè¿è¾“å±‚çš„å¤ç”¨å’Œåˆ†ç”¨åŠŸèƒ½éƒ½è¦é€šè¿‡ç«¯å£å®ç°ã€‚
- 2)åºå·seq
  - å 4Bï¼ŒèŒƒå›´ä¸º$0ï½2^{32}-1$ï¼Œå…±$2^{23}$ä¸ªåºå·ã€‚
    - æ³¨æ„æ˜¯ä»0å¼€å§‹ç¼–å·çš„
  - TCPæ˜¯é¢å‘å­—èŠ‚æµçš„ï¼ˆå³TCPä¼ é€æ—¶æ˜¯é€ä¸ªå­—èŠ‚ä¼ é€çš„)ï¼Œæ‰€ä»¥TCPè¿æ¥ä¼ é€çš„**å­—èŠ‚æµ**ä¸­çš„**æ¯ä¸ªå­—èŠ‚éƒ½æŒ‰é¡ºåºç¼–å·ã€‚**
  - åºå·å­—æ®µçš„å€¼æŒ‡çš„æ˜¯<u>æœ¬æŠ¥æ–‡æ®µæ‰€å‘é€çš„æ•°æ®çš„**ç¬¬ä¸€ä¸ªå­—èŠ‚çš„åºå·**</u>ã€‚
    - ä¾‹å¦‚
      - ä¸€æŠ¥æ–‡æ®µçš„åºå·å­—æ®µå€¼æ˜¯301ï¼Œè€Œæºå¸¦çš„æ•°æ®å…±æœ‰100Bï¼Œè¡¨æ˜æœ¬æŠ¥æ–‡æ®µçš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·æ˜¯400ï¼Œå› æ­¤ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„æ•°æ®åºå·åº”ä»401å¼€å§‹
    - ä¹Ÿå¯ä»¥ç†è§£ä¸ºå“åº”å¯¹æ–¹æŠ¥æ–‡çš„ackå­—æ®µæ‰€æŒ‡çš„,éœ€è¦å‘é€çš„ä¸‹ä¸€ä¸ªæŠ¥æ–‡é¦–å­—èŠ‚åºå·
      - ä¸»è¦æ˜¯åœ¨ä¼ è¾“é˜¶æ®µ
      - åœ¨è¿æ¥é˜¶æ®µå’Œé‡Šæ”¾è¿æ¥çš„å«ä¹‰æ—¶å€™æœ‰æ‰€ä¸åŒ
- 3ï¼‰ç¡®è®¤å·ack
  - å 4B
  - ç¬¬ä¸€å±‚æ„æ€:è‹¥ç¡®è®¤å·ä¸ºN,åˆ™è¡¨æ˜åˆ°åºå·N-1ä¸ºæ­¢çš„æ‰€æœ‰æ•°æ®éƒ½å·²æ­£ç¡®æ”¶åˆ°
  - ç¬¬äºŒå±‚æ„æ€:æ˜¯æœŸæœ›æ”¶åˆ°å¯¹æ–¹ä¸‹ä¸€ä¸ªæŠ¥æ–‡æ®µçš„ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚çš„åºå·ã€‚
  - ä¾‹å¦‚
    - B**æ­£ç¡®æ”¶åˆ°**äº†Aå‘é€è¿‡æ¥çš„ä¸€ä¸ªæŠ¥æ–‡æ®µ
      - å…¶åºå·å­—æ®µæ˜¯501ï¼Œè€Œæ•°æ®é•¿åº¦æ˜¯200B(åºå·501~700)ï¼Œ
      - è¿™è¡¨æ˜B**æ­£ç¡®æ”¶åˆ°**äº†Aå‘é€çš„**åˆ°åºå·700ä¸ºæ­¢çš„æ•°æ®**ã€‚
    - å› æ­¤BæœŸæœ›æ”¶åˆ°Açš„ä¸‹ä¸€ä¸ªæ•°æ®åºå·æ˜¯**701**ï¼Œ
      - äºæ˜¯Båœ¨å‘é€ç»™Açš„**ç¡®è®¤æŠ¥æ–‡æ®µ**ä¸­**æŠŠç¡®è®¤å·ç½®ä¸º701**ã€‚
- 4)`æ•°æ®åç§»`data offsetï¼ˆå³==é¦–éƒ¨é•¿åº¦==)ã€‚
  - å 4ä½ï¼Œè¿™é‡Œä¸æ˜¯IPæ•°æ®æŠ¥åˆ†ç‰‡çš„é‚£ä¸ªæ•°æ®åç§»ï¼Œè€Œæ˜¯è¡¨ç¤º**é¦–éƒ¨é•¿åº¦**
    - é¦–éƒ¨ä¸­è¿˜æœ‰é•¿åº¦ä¸ç¡®å®šçš„é€‰é¡¹å­—æ®µ
    - **æ•°æ®åç§»**(data offset)æŒ‡å‡º,TCPæŠ¥æ–‡æ®µçš„**æ•°æ®èµ·å§‹å¤„**è·ç¦»**TCPæŠ¥æ–‡æ®µçš„èµ·å§‹å¤„**æœ‰å¤šè¿œ
      - â€œæ•°æ®åç§»â€çš„å•ä½æ˜¯32ä½ï¼ˆä»¥4Bä¸ºè®¡ç®—å•ä½)ã€‚
      - å› æ­¤å½“æ­¤å­—æ®µçš„å€¼ä¸º15æ—¶ï¼Œè¾¾åˆ°TCPé¦–éƒ¨çš„æœ€å¤§é•¿åº¦60B(4*15=60)ã€‚
- 5)ä¿ç•™
  - å 6ä½,ä¿ç•™ä¸ºä»Šåä½¿ç”¨ï¼Œä½†ç›®å‰åº”ç½®ä¸º0ã€‚

#### æ ‡å¿—ä½

- 6ï¼‰`ç´§æ€¥ä½URG`ã€‚

  - URG=1æ—¶ï¼Œè¡¨æ˜ç´§æ€¥æŒ‡é’ˆå­—æ®µæœ‰æ•ˆã€‚
  - å®ƒå‘Šè¯‰ç³»ç»Ÿæ­¤æŠ¥æ–‡æ®µä¸­æœ‰ç´§æ€¥æ•°æ®,åº”å°½å¿«ä¼ é€ï¼ˆç›¸å½“äºé«˜ä¼˜å…ˆçº§çš„æ•°æ®)ã€‚
  - ä½†URGéœ€è¦å’Œ`ç´§æ€¥æŒ‡é’ˆå­—æ®µ(2Bytes:16bit)`é…åˆä½¿ç”¨
    - å³æ•°æ®ä»**ç¬¬ä¸€ä¸ªå­—èŠ‚**åˆ°**ç´§æ€¥æŒ‡é’ˆæ‰€æŒ‡å­—èŠ‚**å°±æ˜¯ç´§æ€¥æ•°æ®ã€‚

- 7ï¼‰ç¡®è®¤ä½ACKã€‚

  - ä»…å½“ACK=1æ—¶ç¡®è®¤å·å­—æ®µæ‰æœ‰æ•ˆã€‚
  - å½“ACK=0æ—¶ï¼Œç¡®è®¤å·æ— æ•ˆã€‚
  - <u>TCPè§„å®šï¼Œåœ¨**è¿æ¥å»ºç«‹å**æ‰€æœ‰ä¼ é€çš„æŠ¥æ–‡æ®µéƒ½å¿…é¡»æŠŠACKç½®1ã€‚</u>ğŸˆ

- 8)æ¨é€ä½PSH(Push)ã€‚

  - æ¥æ”¶æ–¹TCPæ”¶åˆ°PSH=1çš„æŠ¥æ–‡æ®µï¼Œå°±å°½å¿«åœ°äº¤ä»˜ç»™æ¥æ”¶åº”ç”¨è¿›ç¨‹ï¼Œ
  - è€Œä¸å†ç­‰åˆ°æ•´ä¸ªç¼“å­˜éƒ½å¡«æ»¡åå†å‘ä¸Šäº¤ä»˜ã€‚

- 9ï¼‰å¤ä½ä½RST (Reset)ã€‚

  - RST= 1æ—¶ï¼Œè¡¨æ˜TCPè¿æ¥ä¸­å‡ºç°**ä¸¥é‡å·®é”™**ï¼ˆå¦‚ä¸»æœºå´©æºƒæˆ–å…¶ä»–åŸå› )ï¼Œ**å¿…é¡»é‡Šæ”¾è¿æ¥**ï¼Œç„¶åå†é‡æ–°å»ºç«‹è¿è¾“è¿æ¥ã€‚

- 10ï¼‰`åŒæ­¥ä½SYN`ã€‚

  - åŒæ­¥`SYN=1`è¡¨ç¤ºè¿™æ˜¯ä¸€ä¸ª**è¿æ¥è¯·æ±‚**æˆ–**è¿æ¥æ¥å—**æŠ¥æ–‡ã€‚

  - å½“`SYN=1ï¼ŒACK=0`æ—¶ï¼Œè¡¨æ˜è¿™æ˜¯ä¸€ä¸ª**è¿æ¥è¯·æ±‚æŠ¥æ–‡**ï¼Œ
    - å¯¹æ–¹è‹¥åŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™åº”åœ¨**å“åº”æŠ¥æ–‡**ä¸­ä½¿ç”¨`SYN= 1ï¼ŒACK=1`ã€‚

- 11)`ç»ˆæ­¢ä½FIN `(Finish)ã€‚ç”¨æ¥é‡Šæ”¾ä¸€ä¸ªè¿æ¥ã€‚

  - å½“FIN = 1æ—¶ï¼Œè¡¨æ˜æ­¤æŠ¥æ–‡æ®µçš„`å‘é€æ–¹çš„æ•°æ®`å·²å‘é€å®Œæ¯•ï¼Œå¹¶è¦æ±‚`é‡Šæ”¾`ä¼ è¾“è¿æ¥ã€‚


#### å…¶ä»–å­—æ®µ

- 12ï¼‰çª—å£window size
  - å 2Bã€‚èŒƒå›´$0\sim{2^{16}-1}(0\sim{65535})$
    - å®ƒæŒ‡å‡ºç°åœ¨å…è®¸å¯¹æ–¹å‘é€çš„æ•°æ®é‡ï¼Œæ¥æ”¶æ–¹çš„æ•°æ®ç¼“å­˜ç©ºé—´æ˜¯æœ‰é™çš„
    - å› æ­¤ç”¨çª—å£å€¼ä½œä¸ºæ¥æ”¶æ–¹è®©å‘	é€æ–¹è®¾ç½®å…¶å‘é€çª—å£çš„ä¾æ®ã€‚
    - ä¾‹å¦‚ï¼Œè®¾
      - ç¡®è®¤å·æ˜¯701ï¼Œçª—å£å­—æ®µæ˜¯1000ã€‚
      - è¿™è¡¨æ˜ï¼Œ**ä»701å·ç®—èµ·**ï¼Œå‘é€æ­¤æŠ¥æ–‡æ®µçš„ä¸€æ–¹è¿˜æœ‰æ¥æ”¶1000å­—èŠ‚æ•°æ®ï¼ˆå­—èŠ‚åºå·ä¸º701ï½1700ï¼‰çš„æ¥æ”¶ç¼“å­˜ç©ºé—´ã€‚

- 13ï¼‰æ ¡éªŒå’Œ checksum

  - å 2Bã€‚æ ¡éªŒå’Œå­—æ®µæ£€éªŒçš„èŒƒå›´åŒ…æ‹¬é¦–éƒ¨å’Œæ•°æ®ä¸¤éƒ¨åˆ†ã€‚

  - åœ¨è®¡ç®—æ ¡éªŒå’Œæ—¶ï¼Œå’ŒUDPä¸€æ ·ï¼Œè¦åœ¨TCPæŠ¥æ–‡æ®µçš„å‰é¢åŠ ä¸Š12Bçš„`ä¼ªé¦–éƒ¨`(åªéœ€å°†UDPä¼ªé¦–éƒ¨çš„ç¬¬4ä¸ªå­—æ®µï¼Œå³åè®®å­—æ®µçš„17æ”¹æˆ6ï¼Œå…¶ä»–çš„å’ŒUDPä¸€æ ·)ã€‚

- 14ï¼‰`ç´§æ€¥æŒ‡é’ˆ`(urgent pointer)
  - å 2Bã€‚
  - **ç´§æ€¥æŒ‡é’ˆ**ä»…åœ¨<u>æ ‡è®°ä½ä¸­çš„</u>**ç´§æ€¥ä½**URG= 1æ—¶,UrgentPointerå€¼æ‰æœ‰æ„ä¹‰
  - å®ƒæŒ‡å‡ºåœ¨æœ¬æŠ¥æ–‡æ®µä¸­ç´§æ€¥æ•°æ®å…±æœ‰**å¤šå°‘å­—èŠ‚**
    - ç´§æ€¥æ•°æ®åœ¨æŠ¥æ–‡æ®µæ•°æ®çš„æœ€å‰é¢
- 15)é€‰é¡¹ options
  - è¯¥å­—æ®µçš„é•¿åº¦å¯å˜ã€‚
    - TCPæœ€åˆåªè§„å®šäº†ä¸€ç§**é€‰é¡¹**(MSS)
- 16ï¼‰å¡«å……(pad)
  - è¿™æ˜¯ä¸ºäº†ä½¿**æ•´ä¸ªé¦–éƒ¨é•¿åº¦æ˜¯4Bçš„æ•´æ•°å€**ã€‚

#### ackå­—æ®µ & ACKä½

- ç¡®è®¤å·`ack`(4Byte:32bit)(å°å†™çš„ack)
- ç¡®è®¤ä½`ACK`(1ä½:1bit)(å¤§å†™çš„ACK)
  - ç¡®è®¤ä½ACK:ä»…å½“ACK=1æ—¶ç¡®è®¤å·å­—æ®µæ‰æœ‰æ•ˆã€‚
  - å½“ACK=0æ—¶ï¼Œç¡®è®¤å·æ— æ•ˆã€‚
  - ==TCPè§„å®šï¼Œåœ¨è¿æ¥å»ºç«‹åæ‰€æœ‰ä¼ é€çš„æŠ¥æ–‡æ®µéƒ½å¿…é¡»æŠŠACKç½®1ã€‚==

### çª—å£å’Œé€‰é¡¹ä¸­çš„MSS

- æœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦(Maximum **Segment** Size,`MSS`)ã€‚
- MSSæ˜¯TCPæŠ¥æ–‡æ®µä¸­çš„**æ•°æ®å­—æ®µçš„æœ€å¤§é•¿åº¦ï¼ˆæ³¨æ„ä»…ä»…æ˜¯æ•°æ®å­—æ®µ)**ã€‚
  - MSSé™å®šäº†TCPæŠ¥æ–‡æ®µå•æ¬¡å‘é€æœ€å¤§è´Ÿè½½æ•°æ®é‡
- å¦‚æœ**çª—å£**å¾ˆå¤§(è®¾ä¸ºwä¸ªMSS),é‚£ä¹ˆå‘é€ç«¯è‡³å°‘å‘é€wæ¬¡æŠ¥æ–‡æ‰ä¼šå°†å‘é€çª—å£é™åˆ°0ğŸˆ
  - çª—å£å¤§å°(å®¹é‡)å¯ä»¥åˆ†é…åˆ°å‡ ä¸ªTCPæŠ¥æ–‡æ®µä¸­å‘é€
  - çª—å£å®¹é‡å¯ä»¥ä»¥MSSè®¡ç®—,ä¹Ÿå¯ä»¥æ˜¯æŒ‰ç…§**å­—èŠ‚B**æˆ–**åƒå­—èŠ‚kB**æ¥è®¡ç®—
    - $MSS=x(Byte)$
    - $s=wx(Byte)$

#### MSS

- The [maximum segment size](https://en.wikipedia.org/wiki/Maximum_segment_size) (MSS) is the largest amount of data, specified in bytes, that TCP is willing to receive in a single segment. 
- For best performance, the MSS should be set small enough to avoid [IP fragmentation](https://en.wikipedia.org/wiki/IP_fragmentation), which can lead to packet loss and excessive retransmissions. 
- To accomplish this, typically the MSS is announced by each side using the MSS option when the TCP connection is established. The option value is derived from the [maximum transmission unit](https://en.wikipedia.org/wiki/MTU_(networking)) (MTU) size of **the data link layer** of the networks to which the sender and receiver are directly attached. 
- TCP senders can use [path MTU discovery](https://en.wikipedia.org/wiki/Path_MTU_discovery) to infer the minimum MTU along the network path between the sender and receiver, and use this to dynamically adjust the MSS to avoid IP fragmentation within the network.
- MSS announcement may also be called *MSS negotiation* but, strictly speaking, the MSS is not *negotiated*. 
- Two completely independent values of MSS are permitted for the two directions of data flow in a TCP connection,[[25\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-rfc1122-29)[[9\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-rfc9293-9) so there is no need to agree on a common MSS configuration for a bidirectional connection.

#### ä¾‹ğŸ„

- [2017ç»Ÿè€ƒçœŸé¢˜]

  - è‹¥ç”²å‘ä¹™å‘èµ·ä¸€ä¸ªTCPè¿æ¥ï¼Œæœ€å¤§æ®µé•¿MSS=1KB,RTT=5ms,

  - ä¹™å¼€è¾Ÿçš„**æ¥æ”¶ç¼“å­˜rwnd=64KB,**åˆ™ç”²ä»è¿æ¥å»ºç«‹æˆåŠŸè‡³**å‘é€çª—å£è¾¾åˆ°twnd=32KB**,éœ€ç»è¿‡çš„æ—¶é—´è‡³å°‘æ˜¯ï¼ˆAï¼‰ã€‚

    - A.25ms
      B.30ms
      C.160ms
      D.165ms

  - æŒ‰ç…§æ…¢å¼€å§‹ç®—æ³•ï¼Œå‘é€çª—å£=min(æ‹¥å¡çª—å£ï¼Œæ¥æ”¶çª—å£}ï¼Œ

  - åˆå§‹çš„æ‹¥å¡çª—å£ä¸ºæœ€å¤§æŠ¥æ–‡æ®µé•¿åº¦1KBã€‚

  - | i              | 1    | 2    | 3    | 4    | 5    | 6      |
    | -------------- | ---- | ---- | ---- | ---- | ---- | ------ |
    | rwnd(MSS=1KB)  | 64   | 63   | 61   | 57   | 49   | 33     |
    | cwnd(MSS)      | 1    | 2    | 4    | 8    | 16   | **32** |
    | twnd(MSS)      | 1    | 2    | 4    | 8    | 16   | 32     |
    | rwnd_next      | 63   | 61   | 57   | 49   | 33   | 1      |
    | cwnd_next(MSS) | 2    | 4    | 8    | 16   | 32   | 1      |

    

  - æ¯ç»è¿‡ä¸€ä¸ªRTT,æ‹¥å¡çª—å£ç¿»å€ï¼Œå› æ­¤éœ€è‡³å°‘ç»è¿‡5ä¸ªRTT,å‘é€çª—å£æ‰èƒ½è¾¾åˆ°32KB,

  - è¿™é‡Œå‡å®šä¹™èƒ½åŠæ—¶å¤„ç†æ¥æ”¶åˆ°çš„æ•°æ®ï¼Œç©ºé—²çš„æ¥æ”¶ç¼“å­˜â‰¥32KBã€‚

### TCP segment structure@fields

- Source port (16 bits)

  Identifies the sending port.

- Destination port (16 bits)

  Identifies the receiving port.

- Sequence number (32 bits)

  Has a dual role:If the SYN flag is set (1), then this is the initial sequence number. The sequence number of the actual first data byte and the acknowledged number in the corresponding ACK are then this sequence number plus 1.If the SYN flag is clear (0), then this is the accumulated sequence number of the first data byte of this segment for the current session.

- Acknowledgment number (32 bits)

  If the ACK flag is set then the value of this field is the next sequence number that the sender of the ACK is expecting. This acknowledges receipt of all prior bytes (if any). The first ACK sent by each end acknowledges the other end's initial sequence number itself, but no data.

- Data offset (4 bits)

  Specifies the size of the TCP header in 32-bit [words](https://en.wikipedia.org/wiki/Word_(computer_architecture)). The minimum size header is 5 words and the maximum is 15 words thus giving the minimum size of 20 bytes and maximum of 60 bytes, allowing for up to 40 bytes of options in the header. This field gets its name from the fact that it is also the offset from the start of the TCP segment to the actual data.

- Reserved (3 bits)

  For future use and should be set to zero.

- Flags (9 bits)

  - Contains 9 1-bit flags (control bits) as follows:

    - NS (1 bit): ECN-nonce - concealment protection[[a\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-10)
    - CWR (1 bit): Congestion window reduced (CWR) flag is set by the sending host to indicate that it received a TCP segment with the ECE flag set and had responded in congestion control mechanism.[[b\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-added3168-11)
    - ECE (1 bit): ECN-Echo has a dual role, depending on the value of the SYN flag. It indicates:

    

    - URG (1 bit): Indicates that the Urgent pointer field is significant
    - ACK (1 bit): Indicates that the Acknowledgment field is significant. All packets after the initial SYN packet sent by the client should have this flag set.
    - PSH (1 bit): Push function. Asks to push the buffered data to the receiving application.
    - RST (1 bit): Reset the connection
    - SYN (1 bit): Synchronize sequence numbers. Only the first packet sent from each end should have this flag set. Some other flags and fields change meaning based on this flag, and some are only valid when it is set, and others when it is clear.
    - FIN (1 bit): Last packet from sender

- Window size (16 bits)

  The size of the *receive window*, which specifies the number of window size units[[c\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-12) that the sender of this segment is currently willing to receive.[[d\]](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#cite_note-13) (See [Â§ Flow control](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Flow_control) and [Â§ Window scaling](https://en.wikipedia.org/wiki/Transmission_Control_Protocol#Window_scaling).)

- Checksum (16 bits)

  The 16-bit [checksum](https://en.wikipedia.org/wiki/Checksum) field is used for error-checking of the TCP header, the payload and an IP pseudo-header. The pseudo-header consists of the [source IP address](https://en.wikipedia.org/wiki/IPv4#Source_address), the [destination IP address](https://en.wikipedia.org/wiki/IPv4#Destination_address), the [protocol number](https://en.wikipedia.org/wiki/List_of_IP_protocol_numbers) for the TCP protocol (6) and the length of the TCP headers and payload (in bytes).

- Urgent pointer (16 bits)

  - If the URG flag is set, then this 16-bit field is an offset from the sequence number indicating the last urgent data byte.ğŸˆ



# TCPè¿æ¥ç®¡ç†ğŸˆ

- TCPæ˜¯é¢å‘è¿æ¥çš„åè®®ï¼Œå› æ­¤æ¯ä¸ªTCPè¿æ¥éƒ½æœ‰ä¸‰ä¸ªé˜¶æ®µï¼š

  - è¿æ¥å»ºç«‹ã€æ•°æ®ä¼ é€å’Œè¿æ¥é‡Šæ”¾ã€‚
  - TCPè¿æ¥çš„ç®¡ç†å°±æ˜¯:
    - ä½¿è¿è¾“è¿æ¥çš„å»ºç«‹å’Œé‡Šæ”¾éƒ½èƒ½æ­£å¸¸è¿›è¡Œã€‚

- åœ¨TCPè¿æ¥å»ºç«‹çš„è¿‡ç¨‹ä¸­ï¼Œè¦è§£å†³ä»¥ä¸‹ä¸‰ä¸ªé—®é¢˜ï¼š

  - 1)è¦ä½¿æ¯ä¸€æ–¹èƒ½å¤Ÿç¡®çŸ¥å¯¹æ–¹çš„å­˜åœ¨ã€‚

  - 2)è¦å…è®¸åŒæ–¹åå•†ä¸€äº›å‚æ•°
    - å¦‚æœ€å¤§çª—å£å€¼ã€æ˜¯å¦ä½¿ç”¨çª—å£æ‰©å¤§é€‰é¡¹ã€æ—¶é—´æˆ³é€‰é¡¹åŠæœåŠ¡è´¨é‡ç­‰

  - 3)èƒ½å¤Ÿå¯¹è¿è¾“å®ä½“èµ„æºè¿›è¡Œåˆ†é…
    - å¦‚ç¼“å­˜å¤§å°ã€è¿æ¥è¡¨ä¸­çš„é¡¹ç›®ç­‰
  - TCPæŠŠè¿æ¥ä½œä¸ºæœ€åŸºæœ¬çš„æŠ½è±¡ï¼Œæ¯æ¡TCPè¿æ¥æœ‰ä¸¤ä¸ªç«¯ç‚¹
    - TCPè¿æ¥çš„ç«¯å£å³ä¸º**å¥—æ¥å­—(Socket)**æˆ–æ’å£
      - è€Œä¸æ˜¯åº”ç”¨è¿›ç¨‹ï¼Œä¹Ÿä¸æ˜¯ä¼ è¾“å±‚çš„åè®®ç«¯å£ã€‚
    - æ¯æ¡TCPè¿æ¥å”¯ä¸€åœ°è¢«é€šä¿¡çš„ä¸¤ä¸ªç«¯ç‚¹ï¼ˆå³ä¸¤ä¸ªå¥—æ¥å­—ï¼‰ç¡®å®šã€‚

## TCPè¿æ¥æ¨¡å¼

- TCPè¿æ¥çš„å»ºç«‹é‡‡ç”¨å®¢æˆ·/æœåŠ¡å™¨æ¨¡å¼
- ä¸»åŠ¨å‘èµ·è¿æ¥å»ºç«‹çš„åº”ç”¨è¿›ç¨‹ç§°ä¸ºå®¢æˆ·(Client),
- è¢«åŠ¨ç­‰å¾…è¿æ¥å»ºç«‹çš„åº”ç”¨è¿›ç¨‹ç§°ä¸ºæœåŠ¡å™¨(Server)ã€‚

-------
##   TCPè¿æ¥å»ºç«‹è¿‡ç¨‹@ä¸‰æ¬¡æ¡æ‰‹ğŸˆ

- TCPè¿æ¥çš„å»ºç«‹ç»å†3ä¸ªæ­¥éª¤,é€šå¸¸ç§°ä¸ºä¸‰æ¬¡æ¡æ‰‹(3-way handshake)

### Protocol operation



- TCP protocol operations may be divided into three phases. 
  - *Connection establishment* is a multi-step handshake process that establishes a connection before entering the *data transfer* phase.
  -  After data transfer is completed, the *connection termination* closes the connection and releases all allocated resources.
- A TCP connection is managed by an operating system through a resource that represents the local end-point for communications, the *[Internet socket](https://en.wikipedia.org/wiki/Internet_socket)*. 
- During the lifetime of a TCP connection, the local end-point **undergoes(ç»å†)** a series of [state](https://en.wikipedia.org/wiki/State_(computer_science)) changes 

#### ğŸˆTCP states(establishment)

- |    State     |     Endpoint      |                         Description                          |
  | :----------: | :---------------: | :----------------------------------------------------------: |
  |    LISTEN    |      Server       | Waiting for a connection request from any remote TCP end-point. |
  |   SYN-SENT   |      Client       | Waiting for a matching connection request after having sent a connection request. |
  | SYN-RECEIVED |      Server       | Waiting for a confirming connection request acknowledgment after having both received and sent a connection request. |
  | ESTABLISHED  | Server and client | An open connection, data received can be delivered to the user. The normal state for the data transfer phase of the connection. |

### è¿æ¥å»ºç«‹å‰

- æœåŠ¡å™¨è¿›ç¨‹å¤„äºLISTENï¼ˆæ”¶å¬ï¼‰çŠ¶æ€ï¼Œç­‰å¾…å®¢æˆ·çš„è¿æ¥è¯·æ±‚ã€‚

### å¼€å§‹å»ºç«‹

- ç¬¬ä¸€æ­¥(SYN):
  - å®¢æˆ·æœºçš„TCPé¦–å…ˆå‘æœåŠ¡å™¨çš„TCPå‘é€**è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µ**ã€‚
  - è¿™ä¸ªç‰¹æ®ŠæŠ¥æ–‡æ®µçš„é¦–éƒ¨ä¸­çš„åŒæ­¥ä½SYNç½®1ï¼ŒåŒæ—¶é€‰æ‹©ä¸€ä¸ªåˆå§‹åºå·seq= xã€‚
  -  `SYNæŠ¥æ–‡æ®µ(å³å»ºç«‹è¿æ¥çš„TCPè¯·æ±‚æŠ¥æ–‡æ®µ)ä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†è¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·`ã€‚
  - è¿™æ—¶ï¼ŒTCPå®¢æˆ·è¿›ç¨‹è¿›å…¥SYN-SENTï¼ˆåŒæ­¥å·²å‘é€ï¼‰çŠ¶æ€ã€‚

- ç¬¬äºŒæ­¥(SYN-ACK):
  - æœåŠ¡å™¨çš„TCPæ”¶åˆ°**è¿æ¥è¯·æ±‚æŠ¥æ–‡æ®µ**åï¼Œå¦‚åŒæ„å»ºç«‹è¿æ¥ï¼Œåˆ™å‘å®¢æˆ·æœº**å‘å›ç¡®è®¤((ç¡®è®¤æŠ¥æ–‡æ®µ)**ï¼Œå¹¶ä¸ºè¯¥TCPè¿æ¥åˆ†é…ç¼“å­˜å’Œå˜é‡ã€‚
  - åœ¨**ç¡®è®¤æŠ¥æ–‡æ®µ**ä¸­ï¼Œ
    - æŠŠSYNä½å’ŒACKä½éƒ½ç½®1ï¼Œ**ç¡®è®¤å·**æ˜¯ack=x+1ï¼Œ
    - åŒæ—¶ä¹Ÿä¸º**è‡ªå·±é€‰æ‹©ä¸€ä¸ªåˆå§‹åºå·**seq=yã€‚

  - `ç¡®è®¤æŠ¥æ–‡æ®µä¸èƒ½æºå¸¦æ•°æ®ï¼Œä½†ä¹Ÿè¦æ¶ˆè€—æ‰ä¸€ä¸ªåºå·ã€‚`
  - è¿™æ—¶ï¼ŒTCPæœåŠ¡å™¨è¿›ç¨‹è¿›å…¥SYN-RCVD(åŒæ­¥æ”¶åˆ°ï¼‰çŠ¶æ€ã€‚

- ç¬¬ä¸‰æ­¥(ACK):
  - å½“`å®¢æˆ·æœºæ”¶åˆ°ç¡®è®¤æŠ¥æ–‡æ®µ`åï¼Œè¿˜è¦`å‘æœåŠ¡å™¨ç»™å‡ºç¡®è®¤`ï¼Œå¹¶ä¸ºè¯¥TCPè¿æ¥åˆ†é…ç¼“å­˜å’Œå˜é‡ã€‚
  - ç¡®è®¤æŠ¥æ–‡æ®µçš„ACKä½ç½®1ï¼Œç¡®è®¤å·ack =y+1ï¼Œåºå·seq=x+1ã€‚
  - **è¯¥æŠ¥æ–‡æ®µå¯ä»¥æºå¸¦æ•°æ®**,ğŸˆ
    - è‹¥ä¸æºå¸¦æ•°æ®åˆ™ä¸æ¶ˆè€—åºå·ã€‚ğŸˆ

  - è¿™æ—¶ï¼ŒTCPå®¢æˆ·è¿›ç¨‹è¿›å…¥ESTABLISHED(å·²å»ºç«‹è¿æ¥ï¼‰çŠ¶æ€ã€‚

- æˆåŠŸè¿›è¡Œä»¥ä¸Šä¸‰æ­¥åï¼Œå°±å»ºç«‹äº†TCPè¿æ¥ï¼Œæ¥ä¸‹æ¥å°±å¯ä»¥ä¼ é€åº”ç”¨å±‚æ•°æ®ã€‚
  - TCPæä¾›çš„æ˜¯å…¨åŒå·¥é€šä¿¡ï¼Œå› æ­¤é€šä¿¡åŒæ–¹çš„åº”ç”¨è¿›ç¨‹åœ¨ä»»ä½•æ—¶å€™éƒ½èƒ½å‘é€æ•°æ®ã€‚


#### èµ„æºåˆ†é…æ—¶æœº

- **æœåŠ¡å™¨ç«¯çš„èµ„æº**æ˜¯åœ¨å®Œæˆç¬¬äºŒæ¬¡æ¡æ‰‹æ—¶åˆ†é…çš„
- **å®¢æˆ·æœºç«¯çš„èµ„æº**æ˜¯åœ¨å®Œæˆç¬¬ä¸‰æ¬¡æ¡æ‰‹æ—¶åˆ†é…çš„
- è¿™å°±ä½¿å¾—`æœåŠ¡å™¨`æ˜“äºå—åˆ°SYNæ´ªæ³›æ”»å‡»ã€‚

#### çŠ¶æ€å˜åŒ–è¿‡ç¨‹

- ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/6be1f4237a9f487083413aa1d5171c80.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAeHVjaGFveGluMTM3NQ==,size_20,color_FFFFFF,t_70,g_se,x_16)

- ç¬¬ä¸‰æ¬¡æ¡æ‰‹çš„æ—¶å€™å·²ç»å¯ä»¥æºå¸¦æ•°æ®å•¦
  - å¦‚æœä¸æºå¸¦,åˆ™ä¸æ¶ˆè€—seqç¼–å·
  - æ— è®ºæ˜¯å¦æºå¸¦æ•°æ®å¸§,éƒ½ä¸å½±å“é‡Šæ”¾é“¾æ¥æ—¶,å¯¹å‘é€æ–¹å‘é€çš„æ•°æ®æ€»é‡çš„è®¡ç®—
  - å› ä¸ºç¬¬ä¸€å¸§çš„ç¼–å·ä¸€å®šæ˜¯x+1(è®¾ç¬¬ä¸€æ¬¡æ¡æ‰‹æŠ¥æ–‡æ®µä¸­seq=x)
- ä¾‹
  - ç¬¬ä¸€æ¬¡æ¡æ‰‹å‘é€çš„SYNæ®µä¸­,seq=x
  - åˆ™ç¬¬ä¸€ä¸ªæ•°æ®å­—èŠ‚è¢«ç¼–å·ä¸ºx+1
  - è¿æ¥é‡Šæ”¾çš„æ—¶å€™,ç¬¬ä¸€æ¬¡æŒ¥æ‰‹FINæŠ¥æ–‡æ®µä¸­seq=n
  - é‚£ä¹ˆå‘é€ç«¯å‘ç»™æœåŠ¡ç«¯çš„æ•°æ®é‡ä¸ºn-(x+1)
    - è¿™äº›æŠ¥æ–‡çš„çš„ç¼–å·èŒƒå›´æ˜¯[x+1,n-1]
    - å‡è®¾ä¸­é€”æ²¡æœ‰ä»»ä½•é‡ä¼ 

### å°ç»“ğŸˆ

- å»ºç«‹/æ–­å¼€TCPè¿æ¥è¿‡ç¨‹ä¸­çš„æŠ¥æ–‡ä¸æºå¸¦æ•°æ®

  - æ•°æ®å­—èŠ‚æµåœ¨åœ¨æ•°æ®ä¼ é€é˜¶æ®µçš„TCPæŠ¥æ–‡æ‰å¼€å§‹æºå¸¦æ•°æ®å­—èŠ‚æµ
  - æ•°æ®ä¼ è¾“é˜¶æ®µä¼šæœ‰ç¡®è®¤TCPæŠ¥æ–‡,è¿™ç±»ç”¨äºè¡¨ç¤ºç¡®è®¤çš„TCPæŠ¥æ–‡ä¸€èˆ¬ä¹Ÿä¸ä¼šå¸¦æœ‰æ•°æ®éƒ¨åˆ† 

- äº¤æ¢æŠ¥æ–‡çš„è¿‡ç¨‹ä¸­,ç›¸é‚»çš„æŠ¥æ–‡çš„seqä¸ackå­˜åœ¨ä¸€å®šçš„è”ç³».(äº¤å‰è”ç³»)ğŸˆ

  - ä½†æ˜¯ä¸¤æ¬¡ç›¸é‚»çš„æ¡æ‰‹æŠ¥æ–‡ä¸­çš„seqå´æ²¡æœ‰ç›´æ¥å…³ç³»,å®ƒä»¬å¯èƒ½ç‹¬ç«‹éšæœºç”Ÿæˆçš„

  - å¯ä»¥åˆ†åˆ«å°†å®¢æˆ·æœºå’ŒæœåŠ¡å™¨å‘é€çš„æŠ¥æ–‡æ®µä¸­çš„seqå­—æ®µè®°ä¸º$seq_{c}$å’Œ$seq_{s}$

  - ç±»ä¼¼çš„æœ‰$ack_cå’Œack_s$

  - åœ¨å»ºç«‹è¿æ¥çš„ä¸‰æ¬¡æ¡æ‰‹ä¸­:

    - ç”±äºæ­¤é˜¶æ®µçš„æŠ¥æ–‡æ®µæ•°æ®éƒ¨åˆ†æ˜¯ç©ºçš„,å› æ­¤:

    - $$
      ack_s=seq_c+1
      \\
      ack_c=seq_s+1
      $$

    - è€Œåœ¨ä¼ è¾“é˜¶æ®µè§„å¾‹å°±ä¸æ˜¯è¿™æ ·çš„,è€Œæ˜¯è¦ç»“åˆæ”¶åˆ°çš„æŠ¥æ–‡æ•°æ®éƒ¨åˆ†é•¿åº¦åšåŠ æ³•

      - ä¾‹å¦‚cå‘é€ç»™sçš„æŠ¥æ–‡seq=x,ack=y;é•¿åº¦ä¸ºLcå­—èŠ‚
      - é‚£ä¹ˆså‘å›ç»™cçš„ç¡®è®¤æŠ¥æ–‡ä¸­,$ack_s=x+Lc$
      - ä¾‹é¢˜æŸ¥çœ‹TCPæµé‡æ§åˆ¶éƒ¨åˆ†,è¿™éƒ¨åˆ†ä¸»è¦æ˜¯æ•°æ®ä¼ è¾“é˜¶æ®µçš„å†…å®¹

  - TCPä¼ è¾“é˜¶æ®µ&é‡Šæ”¾è¿æ¥é˜¶æ®µ(éè¿æ¥å»ºç«‹é˜¶æ®µ)æ—¶,æœ‰

    - $$
      seq_s=ack_c
      \\
      seq_c=ack_s
      $$

    - è¿æ¥å»ºç«‹

      - ä¸‰æ¬¡æ¡æ‰‹ä¸­çš„å‰ä¸¤ä¸ªæŠ¥æ–‡æ®µseqå–å€¼å¯èƒ½æ˜¯éšæœºç”Ÿæˆçš„

        

- ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/88ba3fca6fd6494aaec52030aa90eec4.png)



### Connection establishment 

- Before a client attempts to connect with a server, the server must first bind to and listen at a port to open it up for connections: this is called **a passive open**.
-  Once **the passive open** is established, a client may establish a connection by initiating an active open using the three-way (or 3-step) handshake:

1. **SYN**: The active open is performed by the client sending a SYN to the server. 
   - The client sets the segment's sequence number to **a random value A.**
2. **SYN-ACK**: In response, the server replies with a SYN-ACK. 
   - **The acknowledgment number** is set to **one more than the received sequence number** (i.e. **A+1**),
     - from A to A+1;
   -  and **the sequence number** that the server chooses for the packet is **another random number, B**.
3. **ACK**: Finally, the client sends an ACK back to the server.
   -  The sequence number is set to the received acknowledgment value i.e. A+1, and the acknowledgment number is set to one more than the received sequence number i.e. B+1.

- Steps 1 and 2 establish and acknowledge the sequence number for one direction. Steps 2 and 3 establish and acknowledge the sequence number for the other direction. Following the completion of these steps, both the client and server have received acknowledgments and a full-duplex communication is established.

## TCPè¿æ¥çš„é‡Šæ”¾@å››æ¬¡æ¡æ‰‹(æŒ¥æ‰‹)ğŸˆ

- å‚ä¸TCPè¿æ¥çš„ä¸¤ä¸ªè¿›ç¨‹ä¸­çš„ä»»ä½•ä¸€ä¸ªéƒ½èƒ½ç»ˆæ­¢è¯¥è¿æ¥ã€‚
  - å…ˆå‘å‡ºåœæ­¢è¯·æ±‚çš„ä½œä¸ºå®¢æˆ·æœº,å¦ä¸€ç«¯å°±ä½œä¸ºæœåŠ¡å™¨
- TCPè¿æ¥é‡Šæ”¾çš„è¿‡ç¨‹é€šå¸¸ç§°ä¸º**å››æ¬¡æ¡æ‰‹**

- ç¬¬ä¸€æ­¥ï¼š
  - **å®¢æˆ·æœº**æ‰“ç®—å…³é—­è¿æ¥æ—¶ï¼Œå‘å…¶TCPå‘é€è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µï¼Œå¹¶åœæ­¢å‘é€æ•°æ®ï¼Œä¸»åŠ¨å…³é—­TCPè¿æ¥ï¼Œè¯¥æŠ¥æ–‡æ®µçš„ç»ˆæ­¢ä½FNç½®1ï¼Œ
  - åºå·seq=u,å®ƒç­‰äºå‰é¢å·²ä¼ é€è¿‡çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·åŠ 1,
  - FNæŠ¥æ–‡æ®µ**å³ä½¿ä¸æºå¸¦æ•°æ®**ï¼Œä¹Ÿ**æ¶ˆè€—æ‰ä¸€ä¸ªåºå·**ã€‚ğŸˆ
  - è¿™æ—¶ï¼ŒTCP**å®¢æˆ·è¿›ç¨‹**è¿›å…¥**<u>FNWAIT-1(ç»ˆæ­¢ç­‰å¾…I)çŠ¶æ€</u>**ã€‚
  - TCPæ˜¯å…¨åŒå·¥çš„
    - å³å¯ä»¥æƒ³è±¡ä¸ºä¸€æ¡TCPè¿æ¥ä¸Š**æœ‰ä¸¤æ¡æ•°æ®é€šè·¯**ï¼Œå‘é€FNçš„ä¸€ç«¯**ä¸èƒ½å†å‘é€æ•°æ®**ï¼Œå³<u>å…³é—­äº†å…¶ä¸­ä¸€æ¡æ•°æ®é€šè·¯ï¼Œä½†å¯¹æ–¹è¿˜å¯ä»¥å‘é€æ•°æ®</u>ã€‚
- ç¬¬äºŒæ­¥ï¼š
  - æœåŠ¡å™¨æ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåå³**å‘å‡ºç¡®è®¤**ï¼Œ
    - ç¡®è®¤å·ack=u+l,
    - åºå·seq=v,
      - ç­‰äºå®ƒå‰é¢å·²ä¼ é€è¿‡çš„æ•°æ®çš„æœ€åä¸€ä¸ªå­—èŠ‚çš„åºå·åŠ 1ã€‚
    - ç„¶åæœåŠ¡å™¨è¿›å…¥CLOSE-WAITï¼ˆå…³é—­ç­‰å¾…ï¼‰çŠ¶æ€ã€‚
  - æ­¤æ—¶ï¼Œ**ä»å®¢æˆ·æœºåˆ°æœåŠ¡å™¨è¿™ä¸ªæ–¹å‘çš„è¿æ¥å°±é‡Šæ”¾äº†**ï¼Œ
    - TCPè¿æ¥å¤„äº**åŠå…³é—­çŠ¶æ€**
    - $Client\bcancel{\Huge{\to}}{Server}$
  - ä½†æœåŠ¡å™¨è‹¥å‘é€æ•°æ®ï¼Œå®¢æˆ·æœºä»è¦æ¥æ”¶ï¼Œ
    - å³ä»æœåŠ¡å™¨åˆ°å®¢æˆ·æœºè¿™ä¸ªæ–¹å‘çš„è¿æ¥å¹¶æœªå…³é—­ã€‚
    - $Client{\Huge{\leftarrow}}{Server}$
- ç¬¬ä¸‰æ­¥ï¼šè‹¥æœåŠ¡å™¨å·²ç»æ²¡æœ‰è¦å‘å®¢æˆ·æœºå‘é€çš„æ•°æ®ï¼Œå°±é€šçŸ¥TCPé‡Šæ”¾è¿æ¥ï¼Œ
  - æ­¤æ—¶ï¼Œå…¶å‘å‡ºFN=1çš„è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µã€‚
  - è®¾è¯¥æŠ¥æ–‡æ®µçš„åºå·seq=w(åœ¨åŠå…³é—­çŠ¶æ€æœåŠ¡å™¨å¯èƒ½åˆå‘é€äº†ä¸€äº›æ•°æ®,æ‰€ä»¥ç”¨æ–°çš„å­—æ¯è¡¨ç¤º,å½“ç„¶,wå¯èƒ½è¿˜æ—¶ç­‰äºvï¼‰ï¼Œè¿˜é¡»é‡å¤ä¸Šæ¬¡å·²å‘é€çš„ç¡®è®¤å·ck=u+1ã€‚è¿™æ—¶æœåŠ¡å™¨è¿›å…¥LAST-ACKï¼ˆæœ€åç¡®è®¤ï¼‰çŠ¶æ€ã€‚
- ç¬¬å››æ­¥ï¼šå®¢æˆ·æœºæ”¶åˆ°è¿æ¥é‡Šæ”¾æŠ¥æ–‡æ®µåï¼Œå¿…é¡»å‘å‡ºç¡®è®¤ã€‚
  - æŠŠç¡®è®¤æŠ¥æ–‡æ®µä¸­çš„ç¡®è®¤ä½ACKç½®1,ç¡®è®¤å·ack=w+1,åºå·seq=u+1ã€‚
  - æ­¤æ—¶TCPè¿æ¥è¿˜æœªé‡Šæ”¾ï¼Œå¿…é¡»ç»è¿‡æ—¶é—´ç­‰å¾…è®¡æ—¶å™¨è®¾ç½®çš„æ—¶é—´2MSLï¼ˆæœ€é•¿æŠ¥æ–‡æ®µå¯¿å‘½ï¼‰åï¼Œå®¢æˆ·æœºæ‰è¿›å…¥CLOSEDï¼ˆè¿æ¥å…³é—­ï¼‰çŠ¶æ€ã€‚

#### è¿‡ç¨‹ç¤ºæ„å›¾

| ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/f3db982485b9486c85e3c49de559fd7f.png) | ![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/9763b3eaea044161b7272c90d5d1179d.png?x-oss-process=image/watermark,type_d3F5LXplbmhlaQ,shadow_50,text_Q1NETiBAeHVjaGFveGluMTM3NQ==,size_15,color_FFFFFF,t_70,g_se,x_16) |
| ------------------------------------------------------------ | ------------------------------------------------------------ |
| åŒæ–¹éƒ½å„è‡ªå‘é€ä¸€ä¸ªFINæŠ¥æ–‡æ®µ<br />Initatoerå‘é€çš„FINä½œä¸ºæŒ¥æ‰‹ç¬¬ä¸€æ®µ<br />æ¯ä¸ªFINå¸§éƒ½æ˜¯è·Ÿéšå¦ä¸€æ–¹çš„ACKæ®µ<br />è€Œä¸”Receiverå‘é€å›åº”Initiatorçš„ACKæ®µåæ‹–ä½å¤„ç†åç»­ä»»åŠ¡,æ¥ç€å‘é€è‡ªå·±çš„FINæ®µ |                                                              |

#### å°ç»“ğŸˆ

- å®¢æˆ·æœºå‘Šè¯‰æœåŠ¡å™¨è‡ªå·±æƒ³è¦å…³é—­;
- æœåŠ¡å™¨è¡¨ç¤ºçŸ¥é“äº†å®¢æˆ·æœºçš„æ„æ€,å‘Šè¯‰å®¢æˆ·æœºåœ¨ç­‰å¾…ä¸€æ®µæ—¶é—´,è‡ªå·±éœ€è¦å–„åæ£€æŸ¥å’Œå¤„ç†;
- æœåŠ¡å™¨å¤„ç†å®Œå,å‘Šè¯‰å®¢æˆ·æœºè‡ªå·±å¤„ç†å¥½äº†,å¯ä»¥ç»“æŸTCPè¿æ¥;
- å®¢æˆ·ç«¯æ”¶åˆ°é€šçŸ¥å,å›ä¿¡ç»™æœåŠ¡å™¨è¡¨ç¤ºè‡ªå·±çŸ¥é“äº†å–„åå·¥ä½œä¹Ÿéƒ½ç»“æŸäº†,è‡ªå·±å°†åœ¨2MSLåè¿›å…¥å…³é—­çŠ¶æ€(Closed);å¹¶å‘æœåŠ¡å™¨å‘é€ä¸€æ¡å¼¥ç•™ä¹‹è¨€;æœåŠ¡å™¨æ”¶åˆ°å¼¥ç•™ä¹‹è¨€,ç«‹å³å…³é—­æ‰äº†è¿æ¥

#### ğŸˆTCP state(termination)

|   State    |     Endpoint      |                         Description                          |
| :--------: | :---------------: | :----------------------------------------------------------: |
| FIN-WAIT-1 | Server and client | Waiting for a connection termination request from the remote TCP, or an acknowledgment of the connection termination request previously sent. |
| FIN-WAIT-2 | Server and client | Waiting for a connection termination request from the remote TCP. |
| CLOSE-WAIT | Server and client | Waiting for a connection termination request from the local user. |
|  CLOSING   | Server and client | Waiting for a connection termination request acknowledgment from the remote TCP. |
|  LAST-ACK  | Server and client | Waiting for an acknowledgment of the connection termination request previously sent to the remote TCP (which includes an acknowledgment of its connection termination request). |
| TIME-WAIT  | Server or client  | Waiting for enough time to pass to be sure that all remaining packets on the connection have expired. |
|   CLOSED   | Server and client |                 No connection state at all.                  |

##  TCPè¿æ¥å»ºç«‹å’Œé‡Šæ”¾å°ç»“ğŸˆğŸˆ

- 1)è¿æ¥å»ºç«‹ã€‚åˆ†ä¸º3æ­¥:

  - `SYN= 1`ï¼Œseq=xã€‚

  - `SYN = 1ï¼ŒACK = 1`ï¼Œseq=yï¼Œack =xï¼‹1ã€‚

  - `ACK= 1`ï¼Œseq=x + 1ï¼Œack =y+1ã€‚

- 2ï¼‰é‡Šæ”¾è¿æ¥ã€‚åˆ†ä¸º4æ­¥:

  - `FIN=1`ï¼Œseq= uã€‚

  - `ACK= 1`ï¼Œseq= vï¼Œack = u+1ã€‚

  - `FIN=1ï¼ŒACK= 1`ï¼Œseq= wï¼Œack = u + 1ã€‚

  - `ACK = 1`ï¼Œseq  u+1ï¼Œack = w+1ã€‚

  - |      | Client      | Server | Server | Client |
    | ---- | ----------- | ------ | ------ | ------ |
    | seq  | u           | v      | w      | u+1    |
    | ack  | $\clubsuit$ | u+1    | u+1    | w+1    |

------

- è¿æ¥å’Œé‡Šæ”¾:ACKã€SYNã€FINä¸€å®šç­‰äº1

### ä¾‹

-  è‹¥ä¸»æœºç”²ä¸ä¸»æœºä¹™å»ºç«‹ TCP è¿æ¥æ—¶å‘é€çš„ SYN æ®µä¸­çš„åºå·ä¸º 1000ï¼Œåœ¨æ–­å¼€è¿æ¥æ—¶ï¼Œç”²å‘é€ç»™ä¹™çš„ FIN æ®µä¸­çš„åºå·ä¸º 5001ï¼Œåˆ™åœ¨æ— ä»»ä½•é‡ä¼ çš„æƒ…å†µä¸‹ï¼Œç”²å‘ä¹™å·²ç»å‘é€çš„åº”ç”¨å±‚æ•°æ®çš„å­—èŠ‚æ•°ä¸ºï¼šC
  -  Aã€4002 Bã€4001 Cã€4000 Dã€3999 
- ç”²ä¸ä¹™å»ºç«‹TCPè¿æ¥æ—¶å‘é€çš„SYNæ®µä¸­çš„åºå·ä¸º1000ï¼Œåˆ™åœ¨æ•°æ®ä¼ è¾“é˜¶æ®µæ‰€ç”¨çš„èµ·å§‹åºå·ä¸º1001ï¼š
- æ–­å¼€è¿æ¥æ—¶ï¼Œç”²å‘é€ç»™ä¹™çš„FNæ®µä¸­çš„åºå·ä¸º5001ï¼Œåœ¨æ— ä»»ä½•é‡ä¼ çš„æƒ…å†µä¸‹ï¼Œç”²å‘ä¹™å·²ç»å‘é€çš„åº”ç”¨å±‚æ•°æ®çš„å­—èŠ‚æ•°ä¸º5001-1001=4000ã€‚



#  wireSharkåˆ†ææŠ¥æ–‡(reserve+flags)

## ç®€ç•¥ä¿¡æ¯Info
![åœ¨è¿™é‡Œæ’å…¥å›¾ç‰‡æè¿°](https://img-blog.csdnimg.cn/b606b2b70f53483bbc360786553b3244.png)

![](https://img-blog.csdnimg.cn/img_convert/3b6337edc420e5873f056ac2254755f3.png)
![](https://img-blog.csdnimg.cn/img_convert/5225a8dd11dcd2e6cae318c093e20437.png)

- å›¾ä¸­çš„`data offset`å­—æ®µæ‰€å çš„4ä½(4bit)ç”¨äºæè¿°TCPæŠ¥æ–‡é¦–éƒ¨çš„å¤§å°(4bitå¯ä»¥è¡¨ç¤ºçš„æœ€å¤§å€¼1111(å³åè¿›åˆ¶çš„15));é‚£ä¹ˆå•ä½æ˜¯ä»€ä¹ˆ?(æ—¢ä¸æ˜¯Byte,æ›´ä¸æ˜¯bit,è€Œæ˜¯(4Byte)ä¸ºå•ä½);
- TCPæŠ¥æ–‡æ®µ(segment)ä»¥4Byteä¸ºè®¡é‡å•ä½,æ‰€ä»¥é¦–éƒ¨æœ€å¤§ä¸º15*4Byte=60Byte(480bit)
- å³,æè¿°`é¦–éƒ¨é•¿åº¦ä¿¡æ¯çš„å­—æ®µ`å äº†è¿™ä¸ªTCPæŠ¥æ–‡æ®µçš„`é¦–éƒ¨ç©ºé—´`çš„4ä¸ªbit;







