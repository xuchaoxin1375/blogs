## 红黑树RBT

- 红黑树是一棵二叉搜索树(RBT首先是一棵BST)，
  - 它在每个结点上增加了一个存储位来表示结点的颜色，可以是RED或BLACK。
  - 通过对任何一条从**根到叶子的简单路径**上各个结点的颜色进行约束，
  - 红黑树确保**没有**一条路径会**比其他路径长出2倍**，因而是**近似于平衡**的。

### 内部结点和外部结点

- 树中每个结点包含5个属性: color、key、left、right和p。
  - 如果一个结点<u>没有子结点或父结点</u>，则该<u>结点相应指针属性的值为NIL</u>。
  - 我们可以<u>把这些NIL</u>视为指向二叉搜索树的叶结点(**外部结点**)的指针，
  - 而把**带关键字的结点视为树的内部结点**

### 其他性质

- 红黑树上点结点默认情况下是黑色的
  - 根结点是黑色的
  - **外部结点**是黑色的/NULL结点是黑色的
  - 同色相邻(双亲孩子)的结点只能是黑色的
    - 这意味着:
      - 从上往下看:一个**红结点**的子结点必定全是黑色的$\bigstar$
      - 从下网上看:一个红结点的双亲结点必定是黑色的
- RBT中的任意一个结点X到(它的子树/后代的)任意叶子结点的路径中包含的黑结点是一样的
  - 或者说:对每个结点，从该结点到其所有后代叶结点的简单路径上，均包含相同数目的黑色结点。

### 结点的黑高度BH:

- 我们通常将<u>注意力放在红黑树的内部结点上</u>，因为它们存储了关键字的值。

- 从某个结点x出发(不含该结点本身,因为我们将NULL结点视为黑结点,计入路径)到达一个叶结点的任意一条简单路径上的**黑色结点个数**称为该结点x的黑高(black-height)，记为bh(x)。

  - 即,从某个结点X的下一个结点X.next开始到达任意一个**叶子结点**(指不带关键字的黑色NULL结点)的简单路径上的黑结点数量为称为黑高

- 一个结点X可能有多条到达**叶子结点**(不包括NULL结点)的路径,

  - 记这些路径为$XTL_i$(Node X To Leaf Node of Number i)

  - 但是这些路径的长度可能是不同的,但是它们的**黑高度**都是一样的

  - 特别的,当X是根结点R的时候XTL称为**RTL**,此时黑高度称为RBT的黑高度

- 比如,内部结点的黑高度至少为1(NULL结点是黑色的)
  - 而NULL结点的黑高度是0
- 根结点的黑高度代表RBT的黑高度

#### 相关性质

- 从**根结点**到叶结点的路径($RTL_i$)中最长路径$MaxL\leqslant 2\cdot MinL$
  - RTL都是首尾是黑结点的路径
  - 假设某个一个结点X的黑高度为bhx
    - 由于x的所有XTL都含有一样的黑结点
    - 因此,XTL最长的时候,是向XTL中填充尽可能多的红结点
      - 填充的地方只能够是相邻两个黑结点间
      - 最终会形成一条红黑相间的路径
    - 最短的XTL,则是一个红结点都不填充
  - 因此对于RTL,最长路径的结点数上限是红色结和黑色结点一样多(不包括NULL结点),数值为2倍黑高度+1=2(BH(R)+1)
  - 这说明,红黑树中的黑结点至少占全树结点总数的一半(算上NULL结点)
  - 每条从根结点下降到叶子结点的路径RTL上,黑结点也至少占一半

### 含有n个内部结点的RBT高度

- $高度h\leqslant 2\log_2(n+1)$

- 每条从根结点(包含根结点自身)下降到叶子结点(内部结点)的路径RTL上,黑结点至少占一半

- RBT的最长路径是一条RTL,其长度就是代表RBT的高度h

- 我们先讨论h层满二叉树(FBT)和h层任意二叉树之间的关系

  - 后者可以看成是从前者删除掉若干个点后得到的,只要保证高度不变即可
  - 在RBT中,根据前面的分析已经知道,最短路径长度至少是最长路径的一半
  - $对于一棵h层的RBT,每条RTL都是至少有\frac{1}{2}h$
  - $因此,但从前\frac{1}{2}h层来看,至少是满的二叉树$
  - 这里面包含的及结点数量为$2^\frac{h}{2}-1$个
  - $所以n\geqslant2^\frac{h}{2}-1$
    - $\frac{h}{2}\leqslant\log_2(n+1)$
    - $h\leqslant 2\log_2(n+1)$

  

## 红黑树的插入

- 和BST类似,但是需要做维护检查和操作
  - 主要维护红色结点的亲子不同色性
  - 黑高度一致性
- 新结点z初次插入后,将其着为红色
  - 如果作为黑色,会破坏BF(x)黑高度一致性质
  - 新结点着为红色,则不一定破坏RBT性质,可能不需要维护修改
    - 当z的双亲结点为黑色时最理想

### 具体情况包括

- A:z作为红黑树的第一个结点,将作为根结点,要着为黑色
- B:当z的双亲结点z.p为黑色时,直接插入,z着为红色
- C:当z的双亲结点z.p为红色,比较不理想,需要分类讨论
  - 首先,z插入前,树是满足RBT的,可知,如果插入z后的z.p是红的,z.p.p一定是黑的
    - 设,z的叔结点为z.y,z.p为z的父节点,z.p.p为z的爷爷结点,简记为zpp
    - z=z.p.L表示z是他父节点的左孩子
    - z=z.p.R表示z是它父节点的右孩子
    - z=zpp.LL表示z是它爷爷结点的左孩子的左孩子
    - z=zpp.LR表示z是它爷爷结点的左孩子的右孩子
  - case1.1:z.y为黑色,z=z.p.L
    - 如果还满足z=zpp.LL
      - 先将LR做左旋转为LL,再对LL做右旋转得到LNR,再将z与z.p的颜色互换
    - 如果是z=zpp.RL,有类似的对称操作
  - case1.2:z.y黑色,z.p.R
    - 如果还满足z=zpp.LR
      - 类似于case1
  - case2:z.y红色
    - 将z.p&z.y都着为黑色即可(zpp保持黑色即可)

### 删除操作

- 稍微复杂
  - 与n个结点的红黑树上的其他基本操作一样，删除一个结点要花费O(lgn)时间。
  - 与插入操作相比，删除操作要稍微复杂些。
    - 从一棵红黑树中删除结点的过程是基于TREE-DELETE过程而来的。
      - 首先，需要特别设计一个<u>供TREE-DELETE</u>调用的**子过程**`TRANSPLANT`转移/移植，并将其应用到红黑树上:
        - Transplant:move or transfer (someone or something) to another place or situation.
- 旋转的次数可能超过2次

## 性能分析

- 和BBT的查找/插入/删除操作的时间复杂度是一样的
  - 但是系数上,插入和删除RBT更小

















